<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ResurrectOS-Micro // CloudDeck</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg-main: #020308;
      --bg-accent: #050918;
      --bg-window: #050815;
      --border-window: #26ffe6;
      --text-main: #e6faff;
      --text-muted: #6b7b99;
      --accent: #ff2fd4;
      --accent-soft: #26ffe6;
      --danger: #ff4c6a;
      --success: #3dffb8;
      --shadow-window: rgba(0,0,0,0.85);
      --scanline: rgba(0, 255, 170, 0.06);
    }

    * {
      box-sizing: border-box;
      user-select: none;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Courier New", monospace;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,0.96),
          rgba(0,0,0,0.96) 2px,
          var(--scanline) 3px
        ),
        radial-gradient(circle at top, #1b2557 0%, #050515 45%, #00020a 100%);
      color: var(--text-main);
      overflow: hidden;
    }

    /* CRT overlay */
    #crt-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: soft-light;
      opacity: 0.25;
      background:
        radial-gradient(circle at center, transparent 0%, transparent 40%, rgba(0,0,0,0.65) 100%);
    }

    #crt-vignette {
      position: fixed;
      inset: 0;
      pointer-events: none;
      box-shadow:
        inset 0 0 80px rgba(0,0,0,0.9),
        inset 0 0 200px rgba(0,0,0,0.9);
    }

    /* SCREENS ORDER:
       1) BIOS
       2) LOGIN
       3) BOOT
       4) DESKTOP
    */

    /* BIOS screen */
    #bios-screen {
      position: fixed;
      inset: 0;
      background: #04050b;
      color: #baf7ff;
      font-family: "Courier New", monospace;
      font-size: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    #bios-header {
      color: #26ffe6;
      margin-bottom: 1em;
    }

    #bios-body {
      flex: 1;
      white-space: pre-wrap;
    }

    #bios-footer {
      margin-top: 1em;
      color: #6b7b99;
    }

    /* Login screen */
    #login-screen {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top, #15193d 0%, #020308 50%, #000000 100%);
      display: none;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
    }

    #login-panel {
      width: 320px;
      padding: 18px;
      border-radius: 12px;
      border: 1px solid rgba(38,255,230,0.7);
      box-shadow:
        0 0 25px rgba(38,255,230,0.6),
        0 0 80px rgba(0,0,0,0.9);
      background: linear-gradient(135deg, #050918 0%, #020308 60%);
      position: relative;
      overflow: hidden;
    }

    #login-title {
      font-size: 16px;
      letter-spacing: 3px;
      margin-bottom: 6px;
      color: var(--accent-soft);
      text-shadow: 0 0 10px rgba(38,255,230,0.9);
    }

    #login-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .login-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .login-input, .login-select {
      width: 100%;
      padding: 5px 6px;
      margin-top: 2px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(38,255,230,0.5);
      color: var(--text-main);
      font-family: "Courier New", monospace;
      font-size: 12px;
      outline: none;
      border-radius: 4px;
    }

    #login-button {
      margin-top: 10px;
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid rgba(255,47,212,0.8);
      background: linear-gradient(90deg, #ff2fd4, #ff9f40);
      color: #020308;
      font-size: 12px;
      font-family: "Courier New", monospace;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      box-shadow: 0 0 16px rgba(255,47,212,0.8);
    }

    #login-mode-hint {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Boot screen */
    #boot-screen {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top, #10132f 0%, #020308 45%, #000000 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      z-index: 10;
    }

    #boot-frame {
      width: 80%;
      max-width: 760px;
      border-radius: 12px;
      border: 1px solid rgba(38,255,230,0.6);
      box-shadow:
        0 0 20px rgba(38,255,230,0.4),
        0 0 60px rgba(0,0,0,0.9);
      padding: 16px;
      background: linear-gradient(135deg, #040614 0%, #050918 35%, #020308 100%);
      position: relative;
      overflow: hidden;
    }

    #boot-glow {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 10% 0%, rgba(255,47,212,0.35), transparent 55%);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    #boot-title {
      font-size: 20px;
      letter-spacing: 4px;
      color: var(--accent-soft);
      text-shadow: 0 0 10px rgba(38,255,230,0.9);
    }

    #boot-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
      margin-bottom: 12px;
    }

    #boot-log {
      width: 100%;
      height: 150px;
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      border: 1px solid rgba(38,255,230,0.4);
      padding: 8px;
      font-size: 11px;
      overflow-y: auto;
      color: #8af9ff;
    }

    #boot-progress {
      margin-top: 14px;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(8, 16, 40, 0.9);
      overflow: hidden;
      border: 1px solid rgba(255,47,212,0.6);
      box-shadow: 0 0 10px rgba(255,47,212,0.6);
    }

    #boot-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ff2fd4, #ff9f40, #26ffe6);
      box-shadow: 0 0 14px rgba(255,47,212,0.9);
      transition: width 0.4s ease;
    }

    #boot-hint {
      margin-top: 10px;
      font-size: 11px;
      text-align: right;
      color: var(--text-muted);
    }

    #boot-matrix {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 10px;
      color: rgba(38,255,230,0.6);
      text-align: right;
    }

    /* Desktop */
    #desktop {
      position: fixed;
      inset: 0;
      display: none;
    }

    #desktop-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(38,255,230,0.12) 1px, transparent 1px),
        linear-gradient(90deg, rgba(38,255,230,0.12) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.18;
      pointer-events: none;
    }

    #desktop-bg-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 64px;
      letter-spacing: 18px;
      color: rgba(255,255,255,0.02);
      pointer-events: none;
      text-shadow: 0 0 40px rgba(0,0,0,0.9);
      text-transform: uppercase;
    }

    #windows-layer {
      position: absolute;
      inset: 0;
    }

    /* Windows */
    .window {
      position: absolute;
      width: 400px;
      min-height: 220px;
      background:
        linear-gradient(135deg, rgba(38,255,230,0.04), rgba(255,47,212,0.04)),
        radial-gradient(circle at top left, #151c3b 0%, #050515 50%, #020208 100%);
      border-radius: 10px;
      border: 1px solid rgba(38,255,230,0.6);
      outline: 1px solid rgba(0,0,0,0.9);
      box-shadow:
        0 18px 40px var(--shadow-window),
        0 0 20px rgba(38,255,230,0.4);
      color: var(--text-main);
      overflow: hidden;
    }

    .window-header {
      height: 26px;
      background: linear-gradient(90deg, rgba(0,0,0,0.7), rgba(38,255,230,0.22));
      display: flex;
      align-items: center;
      padding: 0 8px;
      cursor: move;
      border-bottom: 1px solid rgba(38,255,230,0.4);
    }

    .window-title {
      flex: 1;
      font-size: 12px;
      color: var(--accent-soft);
      text-shadow: 0 0 8px rgba(38,255,230,0.9);
    }

    .window-controls {
      display: flex;
      gap: 6px;
      margin-right: 4px;
    }

    .wc-btn {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.7);
    }

    .wc-close { background: #ff5f57; }
    .wc-min   { background: #febc2e; }
    .wc-max   { background: #28c840; }

    .window-body {
      padding: 8px;
      font-size: 13px;
      height: calc(100% - 26px);
      overflow: auto;
      color: var(--text-main);
    }

    .window-body pre {
      white-space: pre-wrap;
      margin: 0;
      font-family: "Courier New", monospace;
    }

    /* Dock */
    #dock {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      height: 70px;
      padding: 10px 18px;
      background: rgba(2, 6, 18, 0.85);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      display: flex;
      align-items: flex-end;
      gap: 18px;
      box-shadow:
        0 14px 40px rgba(0,0,0,0.85),
        0 0 18px rgba(38,255,230,0.6);
      border: 1px solid rgba(38,255,230,0.6);
      z-index: 100;
    }

    .dock-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background:
        radial-gradient(circle at top, #2b345f 0%, #050515 60%);
      border: 1px solid rgba(255,255,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.16s ease, margin-top 0.16s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,0.7);
      position: relative;
    }

    .dock-icon:hover {
      transform: scale(1.3);
      margin-top: -8px;
      box-shadow: 0 14px 26px rgba(0,0,0,0.9);
    }

    .dock-indicator {
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 4px;
      border-radius: 999px;
      background: var(--accent-soft);
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 0 8px rgba(38,255,230,0.9);
    }

    .dock-icon.running .dock-indicator {
      opacity: 1;
    }

    /* Utility styles */
    .mono {
      font-family: "Courier New", monospace;
    }

    .notes-area {
      width: 100%;
      min-height: 170px;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(38,255,230,0.4);
      color: var(--text-main);
      padding: 6px;
      resize: vertical;
      font-family: "Courier New", monospace;
      font-size: 13px;
    }

    .system-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .system-table td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .system-table td:first-child {
      color: var(--text-muted);
      width: 120px;
    }

    .centered {
      text-align: center;
    }

    .clock-display {
      font-size: 32px;
      letter-spacing: 4px;
      color: var(--accent-soft);
      text-shadow: 0 0 10px rgba(38,255,230,0.9);
    }

    .credits-text {
      font-size: 12px;
      line-height: 1.4;
    }

    .credits-text span {
      color: var(--accent-soft);
    }

    .lore-body {
      font-size: 12px;
      line-height: 1.5;
    }

    .game-canvas {
      background: #02030a;
      border: 1px solid rgba(38,255,230,0.6);
      box-shadow: 0 0 12px rgba(38,255,230,0.6);
      image-rendering: pixelated;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .terminal-screen {
      background: rgba(0,0,0,0.75);
      border: 1px solid rgba(38,255,230,0.5);
      padding: 6px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 12px;
      color: #7efff3;
    }

    .terminal-input {
      width: 100%;
      background: transparent;
      border: none;
      border-top: 1px solid rgba(38,255,230,0.3);
      padding: 4px;
      color: #7efff3;
      font-family: "Courier New", monospace;
      font-size: 12px;
      outline: none;
    }

    .file-list {
      font-size: 12px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      padding: 2px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .file-item span {
      color: var(--text-muted);
    }

    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin: 4px 0;
    }

    .settings-row label {
      color: var(--text-muted);
    }

    .settings-row input[type="checkbox"] {
      transform: scale(1.1);
    }

    .tag {
      display: inline-block;
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 4px;
      border: 1px solid rgba(38,255,230,0.7);
      color: var(--accent-soft);
      margin-left: 4px;
    }

    .school-muted {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div id="crt-overlay"></div>
  <div id="crt-vignette"></div>

  <!-- Fake BIOS -->
  <div id="bios-screen">
    <div id="bios-header">ResurrectOS-Micro PreBoot Env v0.1</div>
    <div id="bios-body" class="mono">
MEM TEST ................. OK
VRAM SHADER .............. OK
HOLY SILICON CHECK ....... OK
CLOUD BACKEND ............ NONE (STANDALONE RITUAL)
BOOT DEVICE .............. RESURRECTOS.CLOUDDECK

PRESS ENTER TO OPEN LOGIN SHELL
    </div>
    <div id="bios-footer" class="mono">
[Tip] This is the CloudDeck build. No hardware cartridge required.
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen">
    <div id="login-panel">
      <div id="login-title">RESURRECTOS // LOGIN</div>
      <div id="login-sub">CloudDeck session. Choose your persona.</div>

      <div class="login-label">Handle</div>
      <input id="login-user" class="login-input" placeholder="Daxton" value="Daxton">

      <div class="login-label">Mode</div>
      <select id="login-mode" class="login-select">
        <option value="school">School Mode (quiet, muted)</option>
        <option value="hacker">Hacker Mode (full cyber ritual)</option>
      </select>

      <button id="login-button">ENTER SYSTEM</button>
      <div id="login-mode-hint" class="mono">
Mode can be changed later in Settings &gt; Appearance.
      </div>
    </div>
  </div>

  <!-- Boot Screen -->
  <div id="boot-screen">
    <div id="boot-frame">
      <div id="boot-glow"></div>
      <div id="boot-matrix">
        RESURRECTOS//MICRO<br>
        CLOUDDECK BUILD<br>
        ORIGIN: DAXTON MERRILL
      </div>
      <div id="boot-title">RESURRECTOS MICRO / CYBERDECK</div>
      <div id="boot-subtitle">Booting holy silicon ritual environment...</div>
      <div id="boot-log" class="mono"></div>
      <div id="boot-progress">
        <div id="boot-bar"></div>
      </div>
      <div id="boot-hint">[HINT] Tap or press any key after boot completes.</div>
    </div>
  </div>

  <!-- Desktop -->
  <div id="desktop">
    <div id="desktop-grid"></div>
    <div id="desktop-bg-text">RESURRECTOS</div>
    <div id="windows-layer"></div>

    <!-- Dock -->
    <div id="dock">
      <div class="dock-icon" data-app="terminal" title="Terminal" onclick="openApp('terminal')">
        <span>_</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="notes" title="Notes" onclick="openApp('notes')">
        <span>‚úé</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="files" title="File Explorer" onclick="openApp('files')">
        <span>üóÅ</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="system" title="System Info" onclick="openApp('system')">
        <span>‚öô</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="clock" title="Clock" onclick="openApp('clock')">
        <span>üïí</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="lore" title="Lore" onclick="openApp('lore')">
        <span>‚åò</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="credits" title="Credits" onclick="openApp('credits')">
        <span>¬©</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="snake" title="Neon Snake" onclick="openApp('snake')">
        <span>‚ñ§</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="dodger" title="DodgeGrid" onclick="openApp('dodger')">
        <span>‚ñ•</span>
        <div class="dock-indicator"></div>
      </div>
      <div class="dock-icon" data-app="settings" title="Settings" onclick="openApp('settings')">
        <span>‚ò∞</span>
        <div class="dock-indicator"></div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    const globalState = {
      mode: "school", // "school" or "hacker"
      user: "Daxton"
    };

    // ---------- BIOS ‚Üí LOGIN ----------
    document.addEventListener("keydown", (e) => {
      const bios = document.getElementById("bios-screen");
      if (!bios) return;
      if (e.key === "Enter") {
        bios.style.display = "none";
        document.getElementById("login-screen").style.display = "flex";
      }
    });

    document.getElementById("bios-screen").addEventListener("click", () => {
      document.getElementById("bios-screen").style.display = "none";
      document.getElementById("login-screen").style.display = "flex";
    });

    // ---------- LOGIN ----------
    document.getElementById("login-button").addEventListener("click", () => {
      const user = document.getElementById("login-user").value.trim() || "User";
      const mode = document.getElementById("login-mode").value;

      globalState.user = user;
      globalState.mode = mode;

      document.getElementById("login-screen").style.display = "none";
      startBootSequence();
    });

    // ---------- BOOT ----------
    const bootLinesBase = [
      "[BOOT] ResurrectOS-Micro // CyberDeck kernel initializing...",
      "[BUS] Attaching virtual cartridge: CLOUDDECK...",
      "[OK]  Voltage rails: EMULATED. Spirit-level: LINKED.",
      "[MOUNT] Flash FS... SKIPPED (stateless ritual).",
      "[WIRE] UI pipeline: BROWSER <-> CLOUD SHELL.",
      "[SCAN] Peripherals: pointer, keyboard, observer... OK.",
      "[ENV] Desktop skin: macDock + eDEX windows.",
      "[READY] Press any key or tap to enter desktop..."
    ];

    let bootIndex = 0;
    let bootBar = 0;
    let bootUnlocked = false;

    function startBootSequence() {
      const boot = document.getElementById("boot-screen");
      boot.style.display = "flex";
      bootIndex = 0;
      bootBar = 0;
      bootUnlocked = false;
      document.getElementById("boot-log").textContent = "";
      document.getElementById("boot-bar").style.width = "0%";

      // Adjust lines based on mode
      const lines = [...bootLinesBase];
      if (globalState.mode === "school") {
        lines.push("[MODE] School-friendly visuals engaged.");
      } else {
        lines.push("[MODE] Hacker-mode visuals enabled. Expect glow.");
      }
      window._bootLines = lines;
      runBoot();
      document.addEventListener("keydown", tryFinishBoot);
      document.addEventListener("click", tryFinishBoot);
    }

    function appendBootLine(line) {
      const log = document.getElementById("boot-log");
      log.textContent += line + "\n";
      log.scrollTop = log.scrollHeight;
    }

    function runBoot() {
      const lines = window._bootLines || bootLinesBase;
      if (bootIndex < lines.length) {
        appendBootLine(lines[bootIndex]);
        bootIndex++;
        bootBar = Math.min(100, bootBar + (100 / lines.length));
        document.getElementById("boot-bar").style.width = bootBar + "%";
        setTimeout(runBoot, 550);
      } else {
        bootUnlocked = true;
      }
    }

    function tryFinishBoot() {
      if (!bootUnlocked) return;
      bootUnlocked = false;
      document.getElementById("boot-screen").style.display = "none";
      document.getElementById("desktop").style.display = "block";
      applyModeVisuals();
      openApp("terminal");
    }

    // ---------- MODE VISUALS ----------
    function applyModeVisuals() {
      const body = document.body;
      if (globalState.mode === "school") {
        body.classList.add("school-muted");
      } else {
        body.classList.remove("school-muted");
      }
    }

    // ---------- Window manager ----------
    const windows = {};
    let zCounter = 10;

    function createWindow(id, title, contentHTML, width = 400, height = 260) {
      if (windows[id]) {
        focusWindow(id);
        return;
      }

      const win = document.createElement("div");
      win.className = "window";
      win.style.left = (80 + Object.keys(windows).length * 30) + "px";
      win.style.top = (60 + Object.keys(windows).length * 22) + "px";
      win.style.zIndex = zCounter++;
      win.style.width = width + "px";
      win.style.height = height + "px";
      win.dataset.id = id;

      const header = document.createElement("div");
      header.className = "window-header";

      const controls = document.createElement("div");
      controls.className = "window-controls";

      const btnClose = document.createElement("div");
      btnClose.className = "wc-btn wc-close";
      btnClose.onclick = (e) => { e.stopPropagation(); closeWindow(id); };

      const btnMin = document.createElement("div");
      btnMin.className = "wc-btn wc-min";
      btnMin.onclick = (e) => {
        e.stopPropagation();
        win.style.display = "none";
      };

      const btnMax = document.createElement("div");
      btnMax.className = "wc-btn wc-max";
      btnMax.onclick = (e) => {
        e.stopPropagation();
        if (win.dataset.maximized === "1") {
          win.style.left = win.dataset.prevLeft;
          win.style.top = win.dataset.prevTop;
          win.style.width = win.dataset.prevWidth;
          win.style.height = win.dataset.prevHeight;
          win.dataset.maximized = "0";
        } else {
          win.dataset.prevLeft = win.style.left;
          win.dataset.prevTop = win.style.top;
          win.dataset.prevWidth = win.style.width;
          win.dataset.prevHeight = win.style.height;
          win.style.left = "20px";
          win.style.top = "20px";
          win.style.width = "calc(100% - 40px)";
          win.style.height = "calc(100% - 90px)";
          win.dataset.maximized = "1";
        }
      };

      controls.appendChild(btnClose);
      controls.appendChild(btnMin);
      controls.appendChild(btnMax);

      const titleEl = document.createElement("div");
      titleEl.className = "window-title";
      titleEl.textContent = title;

      header.appendChild(controls);
      header.appendChild(titleEl);
      win.appendChild(header);

      const body = document.createElement("div");
      body.className = "window-body";
      body.innerHTML = contentHTML;
      win.appendChild(body);

      document.getElementById("windows-layer").appendChild(win);

      makeWindowDraggable(win, header);
      win.addEventListener("mousedown", () => focusWindow(id));

      windows[id] = win;
      markAppRunning(id, true);
      focusWindow(id);
    }

    function closeWindow(id) {
      const win = windows[id];
      if (!win) return;
      win.remove();
      delete windows[id];
      markAppRunning(id, false);
    }

    function focusWindow(id) {
      const win = windows[id];
      if (!win) return;
      win.style.display = "block";
      win.style.zIndex = zCounter++;
    }

    function makeWindowDraggable(win, handle) {
      let offsetX = 0, offsetY = 0;
      let dragging = false;

      handle.addEventListener("mousedown", (e) => {
        dragging = true;
        offsetX = e.clientX - win.offsetLeft;
        offsetY = e.clientY - win.offsetTop;
        document.body.style.cursor = "move";
      });

      document.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        win.style.left = (e.clientX - offsetX) + "px";
        win.style.top = (e.clientY - offsetY) + "px";
      });

      document.addEventListener("mouseup", () => {
        dragging = false;
        document.body.style.cursor = "default";
      });
    }

    function markAppRunning(appId, running) {
      const icon = document.querySelector('.dock-icon[data-app="' + appId + '"]');
      if (!icon) return;
      if (running) icon.classList.add("running");
      else icon.classList.remove("running");
    }

    // ---------- Apps ----------
    function openApp(appId) {
      switch (appId) {
        case "terminal": openTerminal(); break;
        case "notes":    openNotes(); break;
        case "system":   openSystemInfo(); break;
        case "clock":    openClock(); break;
        case "credits":  openCredits(); break;
        case "snake":    openSnake(); break;
        case "dodger":   openDodger(); break;
        case "about":    openAbout(); break;
        case "lore":     openLore(); break;
        case "files":    openFiles(); break;
        case "settings": openSettings(); break;
      }
    }

    // Terminal
    function openTerminal() {
      const id = "terminal";
      const html = `
        <div class="mono">
          <div class="terminal-screen" id="term-screen">
RESURRECTOS-MICRO // CLOUDDECK
USER: ${globalState.user}
MODE: ${globalState.mode.toUpperCase()}

TYPE 'HELP' FOR COMMANDS.
          </div>
          <input class="terminal-input" id="term-input" placeholder="> type a command..." autocomplete="off" />
        </div>
      `;
      createWindow(id, "Cyber Terminal", html, 480, 280);

      const input = document.getElementById("term-input");
      const screen = document.getElementById("term-screen");

      function printLine(line) {
        screen.textContent += "\n" + line;
        screen.scrollTop = screen.scrollHeight;
      }

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const raw = input.value;
          const cmd = raw.trim().toUpperCase();
          printLine("> " + raw);
          input.value = "";
          if (!cmd) return;

          switch (cmd) {
            case "HELP":
              printLine("AVAILABLE: HELP, ABOUT, MODE, CLEAR, LORE, GAMES");
              break;
            case "ABOUT":
              printLine("ResurrectOS-Micro: CloudDeck build, no hardware cartridge needed.");
              break;
            case "MODE":
              printLine("Current mode: " + globalState.mode.toUpperCase());
              break;
            case "LORE":
              printLine("Open the LORE app from dock for full story.");
              break;
            case "GAMES":
              printLine("Available mini-games: NEON SNAKE, DODGEGRID.");
              break;
            case "CLEAR":
              screen.textContent = "RESURRECTOS-MICRO // CLOUDDECK\nSCREEN CLEARED.";
              break;
            default:
              printLine("UNKNOWN COMMAND. THE CLOUD SHELL SHRUGS.");
              break;
          }
        }
      });

      input.focus();
    }

    // Notes
    function openNotes() {
      const id = "notes";
      const html = `
        <div>
          <p class="hint">Scratchpad is volatile. Close the tab, lose the ritual.</p>
          <textarea class="notes-area" placeholder="Write your ideas, rituals, and coordinates here..."></textarea>
        </div>
      `;
      createWindow(id, "Notes", html, 380, 260);
    }

    // System Info
    function openSystemInfo() {
      const id = "system";
      const html = `
        <table class="system-table mono">
          <tr><td>OS Name</td><td>ResurrectOS-Micro</td></tr>
          <tr><td>Edition</td><td>CloudDeck</td></tr>
          <tr><td>Kernel</td><td>HTML/CSS/JS running in browser</td></tr>
          <tr><td>Origin</td><td>Concept by Daxton Merrill</td></tr>
          <tr><td>Cartridge</td><td>ESP8266 build exists as hardware ritual</td></tr>
          <tr><td>Session</td><td>Ends when tab is closed</td></tr>
          <tr><td>Mode</td><td>${globalState.mode.toUpperCase()}</td></tr>
        </table>
      `;
      createWindow(id, "System Information", html, 420, 250);
    }

    // Clock
    function openClock() {
      const id = "clock";
      const html = `
        <div class="centered">
          <div class="clock-display mono" id="clock-text">--:--:--</div>
          <p class="hint">Time is sourced from your device's internal clock.</p>
        </div>
      `;
      createWindow(id, "Clock", html, 320, 200);
      updateClock();
      if (!window._clockInterval) {
        window._clockInterval = setInterval(updateClock, 1000);
      }
    }

    function updateClock() {
      const el = document.getElementById("clock-text");
      if (!el) return;
      const now = new Date();
      const h = now.getHours().toString().padStart(2, "0");
      const m = now.getMinutes().toString().padStart(2, "0");
      const s = now.getSeconds().toString().padStart(2, "0");
      el.textContent = `${h}:${m}:${s}`;
    }

    // Credits
    function openCredits() {
      const id = "credits";
      const html = `
        <div class="credits-text mono">
          <p><span>ResurrectOS-Micro // CloudDeck Edition</span></p>
          <p>A tiny operating ritual running entirely in your browser.</p>
          <br>
          <p><span>Concept & Lead:</span> Daxton Merrill</p>
          <p><span>System Theme:</span> Retro-future TempleOS spirit, cyberpunk grids, and eDEX-UI energy.</p>
          <p><span>Runtime:</span> Browser-rendered desktop, ESP cartridge optional.</p>
          <br>
          <p>This build is intentionally stateless: when the tab closes, the universe forgets.</p>
        </div>
      `;
      createWindow(id, "Credits", html, 420, 230);
    }

    // About
    function openAbout() {
      const id = "about";
      const html = `
        <div class="mono">
          <p>ResurrectOS-Micro // CloudDeck</p>
          <p>A spiritual successor ritual: part TempleOS homage, part neon shell, part browser altar.</p>
          <p>The ESP cartridge edition exists as the hardware counterpart; this is the everywhere edition.</p>
          <p class="hint">Unplug nothing, carry everything. This build follows you anywhere the web reaches.</p>
        </div>
      `;
      createWindow(id, "About ResurrectOS", html, 420, 220);
    }

    // Lore
    function openLore() {
      const id = "lore";
      const html = `
        <div class="lore-body mono">
          <p><span>LORE: THE RESURRECTION SHELL</span></p>
          <p>In a dead space where operating systems went quiet, a tiny cartridge lit up again.</p>
          <p>ResurrectOS is less an OS and more a ritual: a place to think, write, and play inside a branded void.</p>
          <p>The ESP8266 edition is the physical altar. The CloudDeck edition is the ghost that can haunt any device.</p>
          <br>
          <p>Mode hint:</p>
          <ul>
            <li>School Mode: mutes some glow and flavor text so it looks calmer.</li>
            <li>Hacker Mode: full neon, more attitude, more obvious that this is a toy OS.</li>
          </ul>
        </div>
      `;
      createWindow(id, "Lore", html, 460, 260);
    }

    // Fake File Explorer
    function openFiles() {
      const id = "files";
      const html = `
        <div class="mono">
          <p>CloudDeck File Map <span class="tag">VIRTUAL</span></p>
          <div class="file-list">
            <div class="file-item"><span>/boot/banner.txt</span><span>4 KB</span></div>
            <div class="file-item"><span>/os/desktop.skin</span><span>12 KB</span></div>
            <div class="file-item"><span>/apps/terminal.app</span><span>8 KB</span></div>
            <div class="file-item"><span>/apps/notes.app</span><span>3 KB</span></div>
            <div class="file-item"><span>/apps/games/neon-snake.app</span><span>6 KB</span></div>
            <div class="file-item"><span>/apps/games/dodgegrid.app</span><span>6 KB</span></div>
            <div class="file-item"><span>/lore/codex.txt</span><span>10 KB</span></div>
            <div class="file-item"><span>/system/credits.txt</span><span>2 KB</span></div>
          </div>
          <p class="hint">None of these are real files. Your browser pretends they exist just long enough to impress you.</p>
        </div>
      `;
      createWindow(id, "File Explorer", html, 420, 260);
    }

    // Settings (school/hacker mode)
    function openSettings() {
      const id = "settings";
      const html = `
        <div class="mono">
          <p>Appearance & Mode</p>
          <div class="settings-row">
            <label>School Mode</label>
            <input type="checkbox" id="settings-school">
          </div>
          <div class="settings-row">
            <label>Hacker Mode</label>
            <input type="checkbox" id="settings-hacker">
          </div>
          <p class="hint">
            School Mode: calmer look, slightly muted vibes.<br>
            Hacker Mode: full neon, sharper attitude.
          </p>
        </div>
      `;
      createWindow(id, "Settings", html, 320, 200);

      const school = document.getElementById("settings-school");
      const hacker = document.getElementById("settings-hacker");
      if (globalState.mode === "school") {
        school.checked = true;
        hacker.checked = false;
      } else {
        school.checked = false;
        hacker.checked = true;
      }

      school.addEventListener("change", () => {
        if (school.checked) {
          hacker.checked = false;
          globalState.mode = "school";
          applyModeVisuals();
        } else if (!hacker.checked) {
          school.checked = true;
        }
      });

      hacker.addEventListener("change", () => {
        if (hacker.checked) {
          school.checked = false;
          globalState.mode = "hacker";
          applyModeVisuals();
        } else if (!school.checked) {
          hacker.checked = true;
        }
      });
    }

    // Game: Neon Snake
    function openSnake() {
      const id = "snake";
      const html = `
        <div class="mono centered">
          <canvas id="snake-canvas" width="220" height="220" class="game-canvas"></canvas>
          <p class="hint">Use arrow keys to move. Don't hit the walls or yourself.</p>
        </div>
      `;
      createWindow(id, "Neon Snake", html, 260, 280);

      const canvas = document.getElementById("snake-canvas");
      const ctx = canvas.getContext("2d");
      const gridSize = 11;
      const cell = 20;

      let snake = [{x:5, y:5}];
      let dir = {x:1, y:0};
      let food = {x:8, y:8};
      let alive = true;

      function placeFood() {
        food.x = Math.floor(Math.random() * gridSize);
        food.y = Math.floor(Math.random() * gridSize);
      }

      function update() {
        if (!alive) return;
        const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

        if (head.x < 0 || head.y < 0 || head.x >= gridSize || head.y >= gridSize) {
          alive = false;
        }

        for (let i = 0; i < snake.length; i++) {
          if (snake[i].x === head.x && snake[i].y === head.y) {
            alive = false;
          }
        }

        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          placeFood();
        } else {
          snake.pop();
        }
      }

      function draw() {
        ctx.fillStyle = "#02030a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // grid
        ctx.strokeStyle = "rgba(38,255,230,0.3)";
        for (let i = 0; i <= gridSize; i++) {
          ctx.beginPath();
          ctx.moveTo(i * cell, 0);
          ctx.lineTo(i * cell, gridSize * cell);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(0, i * cell);
          ctx.lineTo(gridSize * cell, i * cell);
          ctx.stroke();
        }

        // snake
        for (let i = 0; i < snake.length; i++) {
          const s = snake[i];
          ctx.fillStyle = i === 0 ? "#26ffe6" : "#ff2fd4";
          ctx.fillRect(s.x * cell + 2, s.y * cell + 2, cell - 4, cell - 4);
        }

        // food
        ctx.fillStyle = "#ffdf40";
        ctx.fillRect(food.x * cell + 4, food.y * cell + 4, cell - 8, cell - 8);

        if (!alive) {
          ctx.fillStyle = "rgba(0,0,0,0.7)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#ff2fd4";
          ctx.font = "16px Courier New";
          ctx.fillText("GAME OVER", 58, 110);
        }
      }

      function loop() {
        update();
        draw();
        if (alive) setTimeout(loop, 140);
      }
      loop();

      document.addEventListener("keydown", snakeKeyHandler);
      function snakeKeyHandler(e) {
        switch (e.key) {
          case "ArrowUp":
            if (dir.y === 1) break;
            dir = {x:0, y:-1};
            break;
          case "ArrowDown":
            if (dir.y === -1) break;
            dir = {x:0, y:1};
            break;
          case "ArrowLeft":
            if (dir.x === 1) break;
            dir = {x:-1, y:0};
            break;
          case "ArrowRight":
            if (dir.x === -1) break;
            dir = {x:1, y:0};
            break;
        }
      }
    }

    // Game: DodgeGrid
    function openDodger() {
      const id = "dodger";
      const html = `
        <div class="mono centered">
          <canvas id="dodger-canvas" width="220" height="220" class="game-canvas"></canvas>
          <p class="hint">Use arrow keys to dodge falling blocks.</p>
        </div>
      `;
      createWindow(id, "DodgeGrid", html, 260, 280);

      const canvas = document.getElementById("dodger-canvas");
      const ctx = canvas.getContext("2d");

      let player = {x: 100, y: 190, w: 16, h: 16};
      let blocks = [];
      let alive = true;
      let tick = 0;

      function spawnBlock() {
        blocks.push({
          x: Math.random() * (canvas.width - 16),
          y: -20,
          w: 16,
          h: 16,
          speed: 2 + Math.random() * 2
        });
      }

      function update() {
        if (!alive) return;
        tick++;
        if (tick % 20 === 0) spawnBlock();

        for (let b of blocks) {
          b.y += b.speed;
        }
        blocks = blocks.filter(b => b.y < canvas.height + 20);

        for (let b of blocks) {
          if (b.x < player.x + player.w &&
              b.x + b.w > player.x &&
              b.y < player.y + player.h &&
              b.y + b.h > player.y) {
            alive = false;
          }
        }
      }

      function draw() {
        ctx.fillStyle = "#02030a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // grid
        ctx.strokeStyle = "rgba(255,47,212,0.35)";
        for (let i = 0; i < canvas.width; i += 20) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
        }

        for (let j = 0; j < canvas.height; j += 20) {
          ctx.beginPath();
          ctx.moveTo(0, j);
          ctx.lineTo(canvas.width, j);
          ctx.stroke();
        }

        // player
        ctx.fillStyle = "#26ffe6";
        ctx.fillRect(player.x, player.y, player.w, player.h);

        // blocks
        ctx.fillStyle = "#ff2fd4";
        for (let b of blocks) {
          ctx.fillRect(b.x, b.y, b.w, b.h);
        }

        if (!alive) {
          ctx.fillStyle = "rgba(0,0,0,0.7)";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#ff2fd4";
          ctx.font = "16px Courier New";
          ctx.fillText("IMPACT DETECTED", 40, 110);
        }
      }

      function loop() {
        update();
        draw();
        if (alive) requestAnimationFrame(loop);
      }
      loop();

      document.addEventListener("keydown", dodgerKeyHandler);
      function dodgerKeyHandler(e) {
        const step = 8;
        switch (e.key) {
          case "ArrowLeft":
            player.x = Math.max(0, player.x - step);
            break;
          case "ArrowRight":
            player.x = Math.min(canvas.width - player.w, player.x + step);
            break;
          case "ArrowUp":
            player.y = Math.max(0, player.y - step);
            break;
          case "ArrowDown":
            player.y = Math.min(canvas.height - player.h, player.y + step);
            break;
        }
      }
    }
  </script>
</body>
</html>
